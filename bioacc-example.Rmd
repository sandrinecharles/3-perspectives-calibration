---
title: "Three perspectives on modelling for ecological risk assessment"
subtitle: "A toy example with a simple one-compartment toxicokinetic model"
author: "Sandrine Charles and Roman Ashauer"
bibliography: bibtex.bib
date: "`r Sys.Date()`"
output:
 pdf_document:
    extra_dependencies: ["empheq", "etoolbox"]
 keep_tex: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "", warning = FALSE, message = FALSE)
# Load required packages
library(tidyverse)
library(rbioacc)
library(kableExtra)
```

### Abstract
We provide here a toy example based on the use of a simple one-compartment toxicokinetic model to describe the bioaccumulation of chemical substances within the whole body of living organisms. From a simple ODE model, we will illustrate : (P1) how to simulate both accumulation and depuration phases under constant exposure and to compare model outputs to observed data; (P2) how to fit such a model on data without using any prior information on the model (Frequentist point of view); (3) how to benefit of prior information in combination with knowledge in data to update the calibration results (Bayesian point of view).

# Introduction

Perform calculations under the three perspectives as described within the main document

# Case study
Based on [@Ashauer2010]. Data set on *Gammarus pulex* exposed to Malathion.

```{r, echo=FALSE, fig.cap="Raw data vizualisation (black dots). the vertical dashed line stands for the end of the accumulation phase ($t_c = 1$ day. Exposure concentration equals 1.485 picomol/ml."}
# Load the data set
df <- read.table("data.txt", header = TRUE, sep = "")
# Plot the raw data
ggplot(data = df, aes(x = time, y = conc)) +
  geom_point() +
  xlab("Time (hours)") +
  ylab("Internal measured concentration (picomol/g wet weight)") +
  geom_vline(xintercept = 1, linetype="dashed")
```


A toxicokinetic (TK) model simply describing bioaccumulation of chemical substances within the whole body of living organisms is based on a set of two differential equations standing for the deterministic part [@Charles2021]:

\begin{subequations}
  \begin{empheq}[left=\empheqlbrace]{align}
    \frac{dC}{dt}(t) &= k_u \times C_w - k_e \times C(t) \quad \forall \, 0 \leq t \leq t_c \\
    \frac{dC}{dt}(t) &= - k_e \times C(t) \quad  \forall \, t > t_c 
  \end{empheq}
\end{subequations}

where $t_c$ stands for the duration of the accumulation phase (namely the end of the exposure period, before organisms are transferred into a clean medium). Quantity $C_w$ stands for the exposure concentration in water, while variable $C(t)$ corresponds to the internal concentration within the whole body of organisms over time $t$. Parameters $k_u$ and $k_e$ are the uptake and the elimination rates, respectively.

Given that state variables are concentrations, an appropriate stochastic part to describe the variability of the data around the mean tendency is the Gaussian distribution, so that:

\begin{equation}
  C_{obs}(t_i) \simeq \mathcal{N}(C(t_i), \sigma)
\end{equation}

where $C_{obs}(t_i)$ are the measured internal concentrations at time point $t_i$, $\forall \, i \in 1,n$, with $n$ the total number of time points. Parameter $\sigma$ stands for the standard deviation of the normal distribution.

# Perspective 1 - 

Under perspective 1, the idea is to simulate under the model equations (1) and to compare with observed data. In this perspective, we used the $k_u$ and $k_e$ parameter estimates as provided in Table 1 of [@Ashauer2010]. However, the estimation of parameter $\sigma$ is missing. In addition, two options can be considered, accounting for the uncertainty or not.

### Persp.1 - option 1

### Persp.1 - option 2

# Perspective 2

# Perspective 3

In the section, we fit the one compartment model (equations (1)) under a Bayesian framework with the R-package `rbioacc` [@Ratier2021]. The same calculation can be easily reproduced on-line with the MOSAIC web platform and its `bioacc` module: \url{https://mosaic.univ-lyon1.fr/bioacc}.

## Model fitting

```{r}
# Prepare the data to be use in the `rbioacc` package
mdf <- modelData(df, time_accumulation = 1, )
# fit the TK model built by default from the data
fit <- fitTK(mdf, refresh = 0)
```

## Model equations

```{r, results='hide'}
# Below is the code line allowing to get
# the used model equations
equations(fit, df)
```

## Fitting results 

```{r}
# Get parameter estimates
# medians and 95% credible intervals
quantile_table(fit)
```

```{r, fig.cap="Fitting plot with black dots representing the observed data, the solid orange line the median predictive model and the grey area the 95% uncertainty band including the uncertainty on the model parameter estimates as well as the stochastic part of the model."}
# Fitting plot
plot(fit)
```

## Bioaccumulation metric

```{r}
# Calculation of the posterior probability distribution
# of the kinetic bioconcentration factor
bm <- bioacc_metric(fit)
# Display median and 95% credible interval of the BCF_k
quantile(bm$BCFk, probs = c(0.025, 0.5, 0.975))
```

The 95\% elimination time can also be easily calulated.

```{r}
signif(t95(fit), digits = 3)
```
## Goodness-of-fit criteria

```{r}
# Posterior Predictive Check (PPC)
# The expectation is to get ~95% of data
# within their prediction interval
ppc(fit)
```

```{r}
# Compare priors and posteriors
plot_PriorPost(fit)
```

```{r}
# Check for correlations between parameters
corrPlot(fit)
```

```{r}
# Check  for non-signigicantly different traces
# of the four MCMC chains run in paralell
psrf(fit)
# Look at the traces of the 4 MCMC chains
mcmcTraces(fit)
```


# References
\bibliographystyle{apacite}
\bibliography{bibtex}
<div id="refs"></div>

\newpage
# APPENDIX 

# Table of raw data

```{r}
df <- read.table("data.txt", header = TRUE, sep = "")
kable(df[1:25,], format="latex")
```

# One more thing

This will be Appendix B.


